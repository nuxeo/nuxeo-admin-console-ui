<div class="json-viewer-container">
  <div class="json-controls sticky-header" *ngIf="currentDepth === 0">
    <div class="controls-left">
      <!-- Search Field - Using plain input with NO Angular event binding for instant response and to improve performance -->
      <div class="search-field-wrapper">
        <input class="search-input" #searchInput [placeholder]="JSON_VIEWER_LABELS.SEARCH_PLACEHOLDER"
          aria-label="Search JSON content - searches automatically as you type or when you press Enter"
          [attr.aria-describedby]="totalMatches > 0 ? 'search-results' : null" (keydown.enter)="triggerSearchOnEnter()"
          tabindex="0">

        <!-- Search Button (visual indicator only when no search term) -->
        <button *ngIf="!searchTerm" mat-icon-button disableRipple [matTooltip]="JSON_VIEWER_LABELS.SEARCH_TOOLTIP"
          aria-label="Search icon" tabindex="-1">
          <mat-icon>{{ JSON_VIEWER_LABELS.MAT_SEARCH_BTN_NAME }}</mat-icon>
        </button>

        <!-- Clear Button -->
        <button *ngIf="searchTerm" mat-icon-button disableRipple (click)="clearSearch()"
          [matTooltip]="JSON_VIEWER_LABELS.CLEAR_SEARCH_TOOLTIP" aria-label="Clear search" tabindex="0">
          <mat-icon>{{ JSON_VIEWER_LABELS.CLEAR }}</mat-icon>
        </button>
      </div>
    </div>
    <div class="controls-center">
      <!-- Search Navigation -->
      <div class="search-navigation"
        *ngIf="totalMatches > 0 || (searchTerm.trim() && totalMatches === 0) || isSearchLoading">
        <span class="search-results" id="search-results" aria-live="polite">{{ searchResultText }}</span>
        <button mat-icon-button disableRipple (click)="goToPreviousMatch()"
          [disabled]="totalMatches === 0 || isSearchLoading" [matTooltip]="JSON_VIEWER_LABELS.PREVIOUS_MATCH_TOOLTIP"
          aria-label="Go to previous search match" tabindex="0">
          <mat-icon>{{ JSON_VIEWER_LABELS.MAT_PREVIOUS_ICON_NAME }}</mat-icon>
        </button>
        <button mat-icon-button disableRipple (click)="goToNextMatch()"
          [disabled]="totalMatches === 0 || isSearchLoading" [matTooltip]="JSON_VIEWER_LABELS.NEXT_MATCH_TOOLTIP"
          aria-label="Go to next search match" tabindex="0">
          <mat-icon>{{ JSON_VIEWER_LABELS.MAT_NEXT_ICON_NAME }}</mat-icon>
        </button>
      </div>
      <span class="search-info-note" *ngIf="totalMatches > 0">
        {{ JSON_VIEWER_LABELS.NOTE_MSG }}
      </span>
    </div>

    <div class="controls-right">
      <!-- Copy Button -->
      <button mat-icon-button disableRipple (click)="copyToClipboard()"
        [matTooltip]="JSON_VIEWER_LABELS.COPY_JSON_TOOLTIP" aria-label="Copy JSON to clipboard" tabindex="0">
        <mat-icon>{{ JSON_VIEWER_LABELS.MAT_COPY_ICON_NAME }}</mat-icon>
      </button>
      <!-- Toggle Expand/Collapse Button -->
      <button mat-raised-button disableRipple (click)="expandOrCollapseAll()" class="toggle-button"
        [attr.aria-label]="expandAll ? 'Collapse all sections' : 'Expand all sections'" tabindex="0">
        <span>{{ expandAll ? JSON_VIEWER_LABELS.COLLAPSE_ALL : JSON_VIEWER_LABELS.EXPAND_ALL }}</span>
        <mat-icon>{{ expandAll ? JSON_VIEWER_LABELS.MAT_UNFOLD_LESS_ICON : JSON_VIEWER_LABELS.MAT_UNFOLD_MORE_ICON
          }}</mat-icon>
      </button>
    </div>

  </div>

  <!-- JSON Content with Search Highlighting -->
  <section class="ngx-json-viewer" [class.loading]="isExpandCollapseLoading || isSearchLoading">

    <!-- Expand/Collapse Loading Overlay -->
    <div class="loading-overlay" *ngIf="isExpandCollapseLoading">
      <mat-spinner diameter="40" class="center-spinner"></mat-spinner>
      <span class="loading-text">{{ expandAll ? JSON_VIEWER_LABELS.COLLAPSE_LOADER_MSG :
        JSON_VIEWER_LABELS.EXPAND_LOADER_MSG }}</span>
    </div>

    <!-- Search Loading Overlay -->
    <div class="loading-overlay" *ngIf="isSearchLoading">
      <mat-spinner diameter="40" class="center-spinner"></mat-spinner>
      <span class="loading-text">{{ JSON_VIEWER_LABELS.LOADING_RESULTS }}</span>
    </div>

    <section *ngFor="let segment of segments" class="segment" 
      [attr.data-segment-key]="segment.key"
      [class.segment-type-number]="segment.type === 'number'"
      [class.segment-type-string]="segment.type === 'string'" [class.segment-type-boolean]="segment.type === 'boolean'"
      [class.segment-type-object]="segment.type === 'object'" [class.segment-type-array]="segment.type === 'array'"
      [class.segment-type-null]="segment.type === 'null'" [class.segment-type-undefined]="segment.type === 'undefined'">

      <section (click)="!searchActive && expandOrCollapseIndividualSegment(segment)"
        (keydown.enter)="!searchActive && expandOrCollapseIndividualSegment(segment)"
        (keydown.space)="!searchActive && expandOrCollapseIndividualSegment(segment)"
        [attr.role]="isExpandable(segment) && !searchActive ? 'button' : null"
        [attr.tabindex]="isExpandable(segment) && !searchActive ? 0 : null"
        [attr.aria-expanded]="isExpandable(segment) ? segment.expanded : null"
        [attr.aria-label]="isExpandable(segment) && !searchActive ? (segment.expanded ? 'Collapse ' + segment.key : 'Expand ' + segment.key) : null"
        [ngClass]="{
        'segment-main': true,
        'expandable': isExpandable(segment) && !searchActive,
        'expanded': segment.expanded,
        'search-disabled': searchActive
      }">
        <div *ngIf="isExpandable(segment)" class="toggler" [class.disabled]="searchActive"></div>
        <span class="segment-key" [innerHTML]="segment.highlightedKey || segment.key"></span>
        <span class="segment-separator">: </span>
        <span *ngIf="!segment.expanded || !isExpandable(segment)" class="segment-value"
          [innerHTML]="segment.highlightedDescription || segment.description"></span>
      </section>

      <section *ngIf="segment.expanded && isExpandable(segment)" class="children">
        <custom-nuxeo-json-viewer [json]="segment.value"
          [expanded]="segment.individuallyExpanded || expandAll || expanded" [depth]="expandAll ? -1 : depth"
          [currentDepth]="currentDepth+1" [expandAll]="expandAll" [isSearchActiveInput]="searchActive">
        </custom-nuxeo-json-viewer>
      </section>
    </section>

  </section>
</div>